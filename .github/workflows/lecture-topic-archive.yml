name: Archive Lecture Topic Issues to Folder

on:
  issues:
    types: [opened, edited, reopened, labeled, unlabeled]

permissions:
  contents: write
  issues: write

jobs:
  archive:
    runs-on: ubuntu-latest
    env:
      FOLDER: "lecture topic tasks"
    steps:
      - id: gate
        env:
          TITLE: ${{ github.event.issue.title }}
          LABELS_JSON: ${{ toJson(github.event.issue.labels.*.name) }}
        run: |
          shopt -s nocasematch
          qualifies=no
          if [[ "$TITLE" =~ lecture[[:space:]-_]*topic[[:space:]-_]*task ]]; then qualifies=yes; fi
          if [[ "$LABELS_JSON" =~ "Lecture Topic Task" ]]; then qualifies=yes; fi
          echo "qualifies=$qualifies" >> $GITHUB_OUTPUT

      - if: steps.gate.outputs.qualifies == 'yes'
        uses: actions/checkout@v4

      - id: name
        if: steps.gate.outputs.qualifies == 'yes'
        env:
          N: ${{ github.event.issue.number }}
          TITLE: ${{ github.event.issue.title }}
          FOLDER: ${{ env.FOLDER }}
        run: |
          mkdir -p "$FOLDER"
          slug="$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g;s/^-|-$//g')"
          filepath="$FOLDER/${N}-${slug}.md"
          echo "filepath=$filepath" >> $GITHUB_OUTPUT
          shopt -s nullglob
          for f in "$FOLDER"/${N}-*.md; do
            if [ "$f" != "$filepath" ]; then git rm -f "$f"; fi
          done

      - if: steps.gate.outputs.qualifies == 'yes'
        env:
          FILEPATH: ${{ steps.name.outputs.filepath }}
        run: |
          n='${{ github.event.issue.number }}'
          url='${{ github.event.issue.html_url }}'
          title='${{ github.event.issue.title }}'
          labels='${{ toJson(github.event.issue.labels.*.name) }}'
          state='${{ github.event.issue.state }}'
          created='${{ github.event.issue.created_at }}'
          updated='${{ github.event.issue.updated_at }}'
          author='${{ github.event.issue.user.login }}'
          body='${{ github.event.issue.body }}'

          cat > "$FILEPATH" <<EOF
---
issue_number: $n
title: "$title"
state: "$state"
url: "$url"
author: "$author"
labels: $labels
created_at: "$created"
updated_at: "$updated"
---

# $title

- **Issue:** [$n]($url)
- **Author:** @$author
- **Labels:** $labels
- **Created:** $created

## Details
$body

> _This file mirrors the issue for reference. Edits to the issue update this file automatically._
EOF

      - if: steps.gate.outputs.qualifies == 'yes'
        env:
          FOLDER: ${{ env.FOLDER }}
        run: |
          set -euo pipefail
          mkdir -p "$FOLDER"
          {
            echo "# Lecture Topic Tasks"
            echo
            echo "| # | Title | Issue |"
            echo "|---:|-------|-------|"
          } > "$FOLDER/README.md"

          shopt -s nullglob
          files=( "$FOLDER"/[0-9]*-*.md )
          printf '%s\n' "${files[@]}" | sort -V -r | while IFS= read -r f; do
            [ "$(basename "$f")" = "README.md" ] && continue
            issue=$(grep -m1 '^issue_number:' "$f" | sed 's/[^0-9]//g')
            title=$(grep -m1 '^title:' "$f" | sed -E 's/^title:[[:space:]]*"?([^"]*)"?/\1/')
            url=$(grep -m1 '^url:' "$f" | sed -E 's/^url:[[:space:]]*"?([^"]*)"?/\1/')
            rel="${f// /%20}"
            [ -z "$title" ] && title="$(basename "$f" .md)"
            echo "| ${issue} | [${title}](${rel}) | [View Issue](${url}) |" >> "$FOLDER/README.md"
          done

      - if: steps.gate.outputs.qualifies == 'yes'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update lecture topic task file and index" || echo "No changes"
          git push

      - if: steps.gate.outputs.qualifies == 'yes'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;
            const rawPath = `/${{ steps.name.outputs.filepath }}`;
            const encodedPath = rawPath.split('/').map(encodeURIComponent).join('/');
            const fileUrl = `https://github.com/${repo.owner}/${repo.repo}/blob/HEAD${encodedPath}`;
            const markerStart = "<!-- LTT-ARCHIVE-LINK:START -->";
            const markerEnd = "<!-- LTT-ARCHIVE-LINK:END -->";
            const bodyBlock = `${markerStart}\nLinked archive file: ${fileUrl}\n${markerEnd}`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number,
              per_page: 100
            });
            const existing = comments.find(c => c.body && c.body.includes(markerStart));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: existing.id,
                body: bodyBlock
              });
            } else {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number,
                body: bodyBlock
              });
            }
